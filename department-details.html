<!DOCTYPE html>
<html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>تفاصيل القسم</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/><link rel="stylesheet" href="styles.css"></head><body><nav class="navbar"><div class="navbar-left"><h1><i class="fas fa-sitemap"></i> <span id="dept-name-header"></span></h1><button id="theme-switcher" title="تبديل الثيم"><i class="fas fa-moon"></i></button></div><a href="dashboard.html" class="nav-link"><i class="fas fa-arrow-right"></i> الرئيسية</a></nav><div class="main-container"><div class="card"><h2 id="employee-list-title"><i class="fas fa-users"></i> موظفو القسم</h2><div class="table-container"><table id="employees-table"><thead><tr><th>الصورة</th><th>الاسم الكامل</th><th>الوظيفة</th><th>الرقم الوظيفي</th><th>صلاحية الهوية</th><th>الإجراءات</th></tr></thead><tbody id="employees-tbody"></tbody></table></div></div></div><div class="credits"><p>برمجة وتصميم: م. عماد علي العتابي</p></div><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><script>const SUPABASE_URL="https://fcqmxsghjzytwewnylye.supabase.co";const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjcW14c2doanp5dHdld255bHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0ODY5OTcsImV4cCI6MjA2NjA2Mjk5N30.m_2k_35IIz992fb-djoI_0w-ltvUhFOeyB_vyFV-Ui8";const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);const deptId=new URLSearchParams(window.location.search).get("id"),employeesTbodyEl=document.getElementById("employees-tbody"),deptNameHeaderEl=document.getElementById("dept-name-header");async function loadDepartmentDetails(){if(!deptId)return document.body.innerHTML="<h1>خطأ: القسم غير محدد.</h1>";employeesTbodyEl.innerHTML=`<tr><td colspan="6" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i></td></tr>`;const{data:e,error:t}=await supabase.from("departments").select("name,employees(*,departments(name))").eq("id",deptId).single();if(employeesTbodyEl.innerHTML="",t||!e)return console.error(t),deptNameHeaderEl.textContent="خطأ",void(employeesTbodyEl.innerHTML='<tr><td colspan="6" style="text-align:center;">لا يمكن عرض البيانات.</td></tr>');deptNameHeaderEl.textContent=`قسم: ${e.name}`,document.title=`موظفو قسم: ${e.name}`;const o=e.employees;if(0===o.length)return void(employeesTbodyEl.innerHTML='<tr><td colspan="6" style="text-align:center;">لا يوجد موظفون.</td></tr>');o.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`<td><img src="${e.photo_url||"https://via.placeholder.com/45"}" class="employee-photo-thumb"></td><td>${e.full_name}</td><td>${e.job_title}</td><td>${e.employee_id||"-"}</td><td>${e.expiry_date||"-"}</td><td><button class="action-btn delete-btn" onclick="deleteEmployee(${e.id},'${e.photo_url}')"><i class="fas fa-trash"></i></button></td>`,employeesTbodyEl.appendChild(t)})}window.deleteEmployee=async(e,t)=>{const{isConfirmed:o}=await Swal.fire({title:"متأكد؟",text:"سيُحذف الموظف!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"نعم"});if(o){const{error:o}=await supabase.from("employees").delete().eq("id",e);if(o)return Swal.fire("خطأ",o.message,"error");t&&"null"!==t&&await supabase.storage.from("employee-photos").remove([t.split("/").pop()]),Swal.fire("تم","حُذف الموظف","success").then(loadDepartmentDetails)}};const themeSwitcher=document.getElementById("theme-switcher"),currentTheme=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",currentTheme),themeSwitcher.innerHTML=`<i class="fas ${"dark"===currentTheme?"fa-sun":"fa-moon"}"></i>`,themeSwitcher.addEventListener("click",()=>{let e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),themeSwitcher.innerHTML=`<i class="fas ${"dark"===e?"fa-sun":"fa-moon"}"></i>`});(async()=>{const{data:{session:e}}=await supabase.auth.getSession();e?loadDepartmentDetails():window.location.href="index.html"})();</script></body></html>